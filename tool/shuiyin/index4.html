<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,IE=10,IE=9,IE=8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
<link href="/favicon.png" rel="icon" type="image/png" />
<script type="text/javascript" src="../../static/js/jquery-2.1.4.js"></script>
<script type="text/javascript" src="./localResizeIMG/dist/lrz.bundle.js"></script>
<title>图片添加水印</title>
<style type="text/css">
#footer {
bottom: 5px;
position: absolute;
color: #999;
font-family: Helvetica, Arial, sans-serif;
font-size: 11px;
}
#repeat-watermark{
position:fixed;
z-index:-1;
top:0;
background: #fff;
}
</style>
</head>

<body>
    <input type="file" name="imgSrc" id="imgSrc"><br/>
    <canvas id="imgCanvas" width="100" height="100">
        Your browser does not support the HTML5 canvas tag.
    </canvas>
    <div id="footer">
        Made by <a href="http://bins.top/blog">Jiangsy</a> <a href="http://bins.top/blog">blog</a>
    </div>
    <script>
        (function(){
var Watermark = function(container, options) { var self = this; self.opt = { docWidth: $(document).width(), docHeight:
$(document).height(), fontStyle: "20px 黑体", //水印字体设置 
rotateAngle: -20 * Math.PI / 180, //水印字体倾斜角度设置 
fontColor:
"rgba(100, 100, 100, 0.1)", //水印字体颜色设置 
firstLinePositionX: -20, //canvas第一行文字起始X坐标 
firstLinePositionY: 80, //Y
SecondLinePositionX: 0, //canvas第二行文字起始X坐标 
SecondLinePositionY: 70 //Y 
}; 
console.info(options);
console.info(self.opt);
$.extend(self.opt, options);
console.info(self.opt);
self.render(container); self.draw(self.opt.docWidth, self.opt.docHeight); self.events(); };



Watermark.prototype = {

render: function(d) {
var self = this;
d.append(tpl);
},
draw: function(docWidth, docHeight) {
var self = this;
self.opt = {
docWidth: $(document).width(),
docHeight: $(document).height(),
fontStyle: "20px 黑体",
//水印字体设置
rotateAngle: -20 * Math.PI / 180,
//水印字体倾斜角度设置
fontColor: "rgba(100, 100, 100, 0.1)",
//水印字体颜色设置
firstLinePositionX: -20,
//canvas第一行文字起始X坐标
firstLinePositionY: 80,
//Y
SecondLinePositionX: 0,
//canvas第二行文字起始X坐标
SecondLinePositionY: 70, //Y
watermark: 'aaaaaa'
};

var cw = $('#watermark')[0];
var crw = $('#repeat-watermark')[0];
crw.width = docWidth;
crw.height = docHeight;
var ctx = cw.getContext("2d"); //清除小画布
ctx.clearRect(0, 0, 160, 100);
ctx.font = self.opt.fontStyle;
//文字倾斜角度
ctx.rotate(self.opt.rotateAngle);
ctx.fillStyle = self.opt.fontColor;
//第一行文字
ctx.fillText(self.opt.watermark, self.opt.firstLinePositionX, self.opt.firstLinePositionY);
//坐标系还原
ctx.rotate(-self.opt.rotateAngle);
var ctxr = crw.getContext("2d");
//清除整个画布
ctxr.clearRect(0, 0, crw.width, crw.height);
//平铺--重复小块的canvas
var pat = ctxr.createPattern(cw, "repeat");
ctxr.fillStyle = pat;
ctxr.fillRect(0, 0, crw.width, crw.height);
},
events: function() {
var self = this;
$(window).resize(function() {
var w = $(document).width();
var h = $(document).height();
self.draw(w, h);
});
}
};
var tpl = '<canvas id="watermark" width="160px" height="100px" style="display:none;"></canvas>' + '<canvas id="repeat-watermark"></canvas>';

var water = new Watermark($('body'), {"watermark" : 'aaaaa'});

        })();
        function readImgToBase64(img, callback) {
            var fr = new FileReader();
                fr.onload = function () {
                // $("#avatarPreview").attr('src', this.result);
                console.log(this.result);
                callback();
            };
            fr.readAsDataURL(img);
        }
        $(function(){
            //获取上传图片
            $('#imgSrc').on('change', function(){
                var img = $("#imgSrc")[0].files[0];
                //压缩图片
                lrz(img, {
                    width: 1000
                }).then(function (rst) {
                    // 处理成功会执行
                    watermarkBuilder(rst.base64);
                }).catch(function (err) {
                    // 处理失败会执行
                }).always(function () {
                    // 不管是成功失败，都会执行
                });
            });

            /**
             * 将Base64图片写入canvas并加入水印
             */
            function watermarkBuilder(imgBase64){
                //准备img对象
                var img = new Image();
                img.src = imgBase64;

                // 加载完成开始绘制
                img.onload = function () {
                    //准备canvas环境
                    var cw = document.getElementById("imgCanvas");
                    cw.width = img.width;
                    cw.height = img.height;

                    //创建水印canvas

                    //合并图片与水印canvas

                    var ctx = cw.getContext("2d");


                    // 绘制图片
                    ctx.drawImage(img, 0, 0);
                    // 绘制水印
                    // ctx.font = "20px 黑体";
                    // ctx.rotate(-20*Math.PI/180);
                    // ctx.fillStyle = "rgba(100,100,100,0.1)";
                    // ctx.fillStyle = "rgba(255,255,255,0.5)";
                    // ctx.fillText("465dd92381", -20, 80); 
                    // ctx.rotate('20*Math.PI/180'); //坐标系还原
                    ctx.font = "20px microsoft yahei";
                    ctx.fillStyle = "rgba(255,255,255,0.5)";
                    ctx.fillText("my mark", 100, 100);


                }
            }




        });
    </script>
    <script type="text/javascript" src="../../static/js/hi.js" ></script>
</body>
</html>