---
title: 领域驱动设计概念分享
date: 2020-10-15
categories:
- tech
tags:
- ddd
---

## 1. 领域驱动设计(DDD:Domain-Driven Design) 介绍
领域驱动设计（DDD）是一种处理高度复杂领域的设计思想，它试图分离技术实现的复杂性，并围绕业务概念构建领域模型来控制业务的复杂性，以解决软件难以理解，难以演进的问题。DDD 不是架构，而是一种架构设计方法论，它通过边界划分将复杂业务领域简单化，帮我们设计出清晰的领域和应用边界，可以很容易地实现架构演进。

### 为什么 DDD 适合微服务？

利用 DDD 设计方法来建立领域模型，划分领域边界，再根据这些领域边界从业务视角来划分微服务边界。而按照 DDD 方法设计出的微服务的业务和应用边界都非常合理，可以很好地实现微服务内部和外部的“高内聚、低耦合”。于是越来越多的人开始把 DDD 作为微服务设计的指导思想。

DDD 包括战略设计和战术设计两部分。

战略设计主要从**业务**视角出发，建立业务领域模型，划分领域边界，建立通用语言的限界上下文，限界上下文可以作为微服务设计的参考边界。

战术设计则从**技术**视角出发，侧重于领域模型的技术实现，完成软件开发和落地，包括：聚合根、实体、值对象、领域服务、应用服务和资源库等代码逻辑的设计和实现。

![](/assets/upload/2020-10/ddd_01.jpg)

### DDD 与微服务的关系

DDD 是一种架构设计方法，微服务是一种架构风格，两者从本质上都是为了追求高响应力，而从业务视角去分离应用系统建设复杂度的手段。   
**DDD 主要关注**：从业务领域视角划分领域边界，构建通用语言进行高效沟通，通过业务抽象，建立领域模型，维持业务和代码的逻辑一致性。    
**微服务主要关注**：运行时的进程间通信、容错和故障隔离，实现去中心化数据管理和去中心化服务治理，关注微服务的独立开发、测试、构建和部署。

## 2. 领域、子域、核心域、通用域和支撑域

### 领域和子域

领域具体指一种特定的范围或区域。领域就是用来确定范围的，范围即边界，这也是 DDD 在设计中不断强调边界的原因。

在研究和解决业务问题时，DDD 会按照一定的规则将业务领域进行细分，当领域细分到一定的程度后，DDD 会将问题范围限定在特定的边界内，在这个边界内建立领域模型，进而用代码实现该领域模型，解决相应的业务问题。简言之，DDD 的领域就是这个边界内要解决的业务问题域。

领域可以进一步划分为子领域。我们把划分出来的多个子领域称为子域，每个子域对应一个更小的问题域或更小的业务范围。

领域建模和微服务建设的过程和方法基本类似，其核心思想就是将问题域逐步分解，降低业务理解和系统实现的复杂度。

### 核心域、通用域和支撑域

在领域不断划分的过程中，领域会细分为不同的子域，子域可以根据自身重要性和功能属性划分为三类子域，它们分别是：**核心域、通用域和支撑域**。
+ 核心域是决定产品和公司核心竞争力的子域，它是业务成功的主要因素和公司的核心竞争力，没有太多个性化的诉求。
+ 通用域是同时被多个子域使用的通用功能子域，比如认证、权限等等，这类应用没有企业特点限制。
+ 支撑域是具有企业特性，但不包含通用功能的子域，比如数据字典等系统。

这三类子域相较之下，核心域是最重要的。

**为什么要划分核心域、通用域和支撑域呢？**

公司在 IT 系统建设过程中，由于预算和资源有限，对不同类型的子域应有不同的关注度和资源投入策略。
很多公司的业务，表面看上去相似，但商业模式和战略方向是存在很大差异的，因此公司的关注点会不一样，在划分核心域、通用域和支撑域时，其结果也会出现非常大的差异。
比如同样都是电商平台的淘宝、天猫、京东和苏宁易购，他们的商业模式是不同的。淘宝是 C2C 网站，个人卖家对个人买家，而天猫、京东和苏宁易购则是 B2C 网站，是公司卖家对个人买家。即便是苏宁易购与京东都是 B2C 的模式，他们的商业模式也是不一样的，苏宁易购是典型的传统线下卖场转型成为电商，京东则是直营加部分平台模式。
商业模式的不同会导致核心域划分结果的不同。有的公司核心域可能在客户服务，有的可能在产品质量，有的可能在物流。在公司领域细分、建立领域模型和系统建设时，我们就要结合公司战略重点和商业模式找到核心域，且重点关注核心域。

## 3. 限界上下文：定义领域边界的利器

### 通用语言

通用语言是通过团队交流达成共识的，能够简单、清晰、准确描述业务涵义和规则的语言。团队成员在同一个领域的软件生命周期里都使用统一的语言进行交流，可以解决交流障碍这个问题，使产品和开发人员能够协同合作，从而确保业务需求的正确表达。
通用语言包含**术语**和**用例场景**，并且能够直接反映在代码中。通用语言中的名词可以给领域对象命名，如商品、订单等等，对应实体对象；而动词则表示一个动作或事件，如商品已下单、订单已付款等，对应领域事件。

语言都有它的语义环境，同样，通用语言也有它的上下文环境。为了避免同样的概念或语义在不同的上下文环境中产生歧义，DDD 在战略设计上提出了“限界上下文”这个概念，用来确定语义所在的领域边界。

### 限界上下文

在不同的时间和背景下，同样的一个东西会有不同的术语。

正如电商领域的商品一样，商品在不同的阶段有不同的术语，在销售阶段是商品，而在运输阶段则变成了货物。同样的一个东西，由于业务领域的不同，赋予了这些术语不同的涵义和职责边界，这个边界就可能会成为未来微服务设计的边界。而边界就是通过限界上下文来定义的。

我们可以将限界上下文拆解为两个词：限界和上下文。限界就是领域的边界，而上下文则是语义环境。

限界上下文用来封装通用语言和领域对象，提供上下文环境，保证在领域之内的一些术语、业务相关对象有一个确切的含义，没有歧义。这个界限定义了模型的适用范围，使团队所有成员能够明确地知道什么应该在模型中实现，什么不应该在模型中实现。

通过领域的限界上下文，就可以在统一的领域边界内用统一的语言进行交流。

### 限界上下文和微服务的关系

理论上限界上下文就是微服务的边界。我们将限界上下文内的领域模型映射到微服务，就完成了从问题域到软件的解决方案。
可以说，限界上下文是微服务设计和拆分的主要依据。在领域模型中，如果不考虑技术异构、团队沟通等其它外部因素，一个限界上下文理论上就可以设计为一个微服务。
当然除了理论，微服务的拆分还是有很多限制因素的，在设计中不宜过度拆分。

## 4. 实体和值对象：领域模型的基础单元

### 实体

在 DDD 中有这样一类对象，它们拥有唯一标识符，且标识符在历经各种状态变更后仍能保持一致。对这些对象而言，重要的不是其属性，而是其延续性和标识，对象的延续性和标识会跨越整个软件的生命周期。我们把这样的对象称为实体。
1. 实体的业务形态
在 DDD 不同的设计过程中，实体的形态是不同的。在战略设计时，实体是领域模型的一个重要对象。领域模型中的实体是多个属性、操作或行为的载体。可以这么理解，实体和值对象是组成领域模型的基础单元。

2. 实体的代码形态
在代码模型中，实体的表现形式是实体类，这个类包含了实体的属性和方法，通过这些方法实现实体自身的业务逻辑。在 DDD 里，这些实体类通常采用充血模型，与这个实体相关的所有业务逻辑都在实体类的方法中实现，跨多个实体的领域逻辑则在领域服务中实现。

> 充血模型：实体中既包括状态，又包括行为，是最符合面向对象的设计方式。

### 值对象

值对象将多个相关属性组合为一个概念整体，描述了领域中的特定的一个方面，并且是一个没有标识符的对象，如果值对象中的属性改变时，可以用另外一个值对象予以替换。  
简单来说，值对象本质上就是一个集合，用于描述目的、具有整体概念和不可修改的属性。在领域建模的过程中，值对象可以保证属性归类的清晰和概念的完整性，避免属性零碎。  
举个栗子：

![](/assets/upload/2020-10/ddd_02.jpg)

我们可以将“省、市、县和街道”等地址相关的零碎属性拿出来构成一个“地址属性集合”，这个集合就是值对象了。

1. 值对象的业务形态
值对象是 DDD 领域模型中的一个基础对象，它跟实体一样都包含了若干个属性，与实体一起构成聚合。本质上，实体是业务对象，具有业务属性、业务行为和业务逻辑。而值对象只是若干个属性的集合，基本不包含业务逻辑。值对象的属性集虽然独立出来了，但在逻辑上它仍然是实体属性的一部分，用于描述实体的特征。
在值对象中也可以有自己的限界上下文，有自己的持久化对象，可以建立共享的数据类微服务，比如数据字典。
2. 值对象的代码形态
值对象在代码中有这样两种形态。如果值对象是单一属性，则直接定义为实体类的属性；如果值对象是属性集合，则把它设计为 Class 类，Class 将具有整体概念的多个属性归集到属性集合，这样的值对象没有 ID，会被实体整体引用。



## 5. 聚合和聚合根：怎样设计聚合？

下面这张图描述了从事件风暴建立通用语言到领域对象设计和代码落地的完整过程。  
![](/assets/upload/2020-10/ddd_03.jpg)

在事件风暴中，我们会根据一些业务操作和行为找出实体（Entity）或值对象（ValueObject），进而将业务关联紧密的实体和值对象进行组合，构成聚合，再根据业务语义将多个聚合划定到同一个限界上下文（Bounded Context）中，并在限界上下文内完成领域建模。

### 聚合

在 DDD 中，实体和值对象是很基础的领域对象。但它们都是个体化的对象，它们的行为表现出来的是个体的能力。
而聚合就是由业务和逻辑紧密关联的实体和值对象组合而成的，聚合是数据修改和持久化的基本单元，每一个聚合对应一个仓储，实现数据的持久化。

### 聚合根

聚合根是一个实体，拥有实体的属性和业务行为，实现自身的业务逻辑，具有全局唯一标识，有独立的生命周期，一个聚合只有一个聚合根。

+ 聚合根在聚合内对实体和值对象采用直接对象引用的方式进行组织并协调完成共同的业务逻辑。
+ 聚合根与聚合根之间通过 ID 关联的方式实现聚合之间的协同，外部对象不能直接访问聚合内实体。

**聚合的一些设计原则**  

《实现领域驱动设计》中对聚合设计原则的描述。  

1. **在一致性边界内建模真正的不变条件。**聚合用来封装真正的不变性，而不是简单地将对象组合在一起。聚合内有一套不变的业务规则，各实体和值对象按照统一的业务规则运行，实现对象数据的一致性，边界之外的任何东西都与该聚合无关，这就是聚合能实现业务高内聚的原因。
2. **设计小聚合。**如果聚合设计得过大，聚合会因为包含过多的实体，导致实体之间的管理过于复杂，高频操作时会出现并发冲突或者数据库锁，最终导致系统可用性变差。而小聚合设计则可以降低由于业务过大导致聚合重构的可能性，让领域模型更能适应业务的变化。
3. **通过唯一标识引用其它聚合。**聚合之间是通过关联外部聚合根 ID 的方式引用，而不是直接对象引用的方式。外部聚合的对象放在聚合边界内管理，容易导致聚合的边界不清晰，也会增加聚合之间的耦合度。
4. **在边界之外使用最终一致性。**聚合内数据强一致性，而聚合之间数据最终一致性。在一次事务中，最多只能更改一个聚合的状态。如果一次业务操作涉及多个聚合状态的更改，应采用领域事件的方式异步修改相关的聚合，实现聚合之间的解耦。
5. **通过应用层实现跨聚合的服务调用。**为实现微服务内聚合之间的解耦，以及未来以聚合为单位的微服务组合和拆分，应避免跨聚合的领域服务调用和跨聚合的数据库表关联。  

上面的这些原则是 DDD 的一些通用的设计原则，在系统设计过程中要考虑项目的具体情况，如果面临使用的便利性、高性能要求、技术能力缺失和全局事务管理等影响因素，这些原则也并不是不能突破的，总之一切以解决实际问题为出发点。

## 6. 领域事件：解耦微服务的关键

在领域模型映射到微服务系统架构时，领域事件可以解耦微服务，

领域事件是领域模型中非常重要的一部分，用来表示领域中发生的事件。一个领域事件将导致进一步的业务操作，在实现业务解耦的同时，还有助于形成完整的业务闭环。
举例来说的话，领域事件可以是业务流程的一个步骤，比如批处理生成对账单，触发发送邮件通知操作；或者一个事件发生后触发的后续动作，比如密码连续输错三次，触发锁定账户和发送通知邮件的动作。

### 最终一致性

微服务之间的数据不必要求强一致性，而是基于事件的最终一致性。  
因为设计聚合的一个原则是：在边界之外使用最终一致性。一次事务最多只能更改一个聚合的状态。如果一次业务操作涉及多个聚合状态的更改，应采用领域事件的最终一致性。  
领域事件驱动设计可以切断领域模型之间的强依赖关系，事件发布完成后，发布方不必关心后续订阅方事件处理是否成功，这样可以实现领域模型的解耦，维护领域模型的独立性和数据的一致性。  

### 微服务之间的领域事件
跨微服务的领域事件会在不同的限界上下文或领域模型之间实现业务协作，其主要目的是实现微服务解耦，减轻微服务之间实时服务访问的压力。    
微服务之间的访问也可以采用应用服务直接调用的方式，实现数据和服务的实时访问，弊端就是跨微服务的数据同时变更需要引入分布式事务，以确保数据的一致性。分布式事务机制会影响系统性能，增加微服务之间的耦合，所以我们还是要尽量避免使用分布式事务。

领域事件总体架构  

![](/assets/upload/2020-10/ddd_04.jpg)

## 7. DDD分层架构：有效降低层与层之间的依赖

DDD 分层架构有一个重要的原则：每层只能与位于其下方的层发生耦合。而架构根据耦合的紧密程度又可以分为两种：严格分层架构和松散分层架构。

+ 严格分层架构：任何层只能对位于其直接下方的层产生依赖。

+ 松散分层架构：允许某层与其任意下方的层发生依赖。

为了服务的可扩展性，一般建议采用严格分层架构。在严格分层架构中，领域服务只能被应用服务调用，而应用服务只能被用户接口层调用，服务是逐层对外封装或组合的，依赖关系清晰。而在松散分层架构中，领域服务可以同时被应用层或用户接口层调用，服务的依赖关系比较复杂且难管理，甚至容易使核心业务逻辑外泄。

下图为 DDD 四层架构 

![](/assets/upload/2020-10/ddd_05.jpg)

1. 用户接口层
用户接口层负责向用户显示信息和解释用户指令。这里的用户可能是：用户、程序、自动化测试和批处理脚本等等。
2. 应用层
应用层是很薄的一层，理论上不应该有业务规则或逻辑，主要面向用例和流程相关的操作。但应用层又位于领域层之上，因为领域层包含多个聚合，所以它可以协调多个聚合的服务和领域对象完成服务编排和组合，协作完成业务操作。  
此外，应用层也是微服务之间交互的通道，它可以调用其它微服务的应用服务，完成微服务之间的服务组合和编排。  
还有，应用服务还可以进行安全认证、权限校验、发送或订阅领域事件等。
3. 领域层
领域层的作用是实现核心业务逻辑，通过各种校验手段保证业务的正确性。领域层主要体现领域模型的业务能力，它用来表达业务概念、业务状态和业务规则。
领域层包含聚合根、实体、值对象、领域服务等领域模型中的领域对象。领域模型的业务逻辑主要是由实体和领域服务来实现的，其中实体会采用充血模型来实现所有与之相关的业务功能。其次，实体和领域服务在实现业务逻辑上不是同级的，当领域中的某些功能，单一实体（或者值对象）不能实现时，领域服务就会出马，它可以组合聚合内的多个实体（或者值对象），实现复杂的业务逻辑。
4. 基础层
基础层是贯穿所有层的，它的作用就是为其它各层提供通用的技术和基础服务，包括第三方工具、驱动、消息中间件、网关、文件、缓存以及数据库等。比较常见的功能还是提供数据库持久化。
基础层包含基础服务，它采用依赖倒置设计，封装基础资源服务，实现应用层、领域层与基础层的解耦，降低外部资源变化对应用的影响。

### 三层架构如何演进到 DDD 分层架构？

DDD 分层架构中的要素其实和三层架构类似，只是在 DDD 分层架构中，这些要素被重新归类，重新划分了层，确定了层与层之间的交互规则和职责边界。

从下面这张图可以分析从三层架构向 DDD 分层架构演进的过程。三层架构向 DDD 分层架构演进，主要发生在业务逻辑层和数据访问层。

![](/assets/upload/2020-10/ddd_06.jpg)

+ DDD 分层架构在用户接口层引入了 DTO，给前端提供了更多的可使用数据和更高的展示灵活性。
+ DDD 分层架构对三层架构的业务逻辑层进行了更清晰的划分，改善了三层架构核心业务逻辑混乱，代码改动相互影响大的情况。DDD 分层架构将业务逻辑层的服务拆分到了应用层和领域层。应用层快速响应前端的变化，领域层实现领域模型的能力。
+ 另外一个重要的变化发生在数据访问层和基础层之间。三层架构数据访问采用 DAO 方式；DDD 分层架构的数据库等基础资源访问，采用了仓储（Repository）设计模式，通过依赖倒置实现各层对基础资源的解耦。
+ 仓储又分为两部分：仓储接口和仓储实现。仓储接口放在领域层中，仓储实现放在基础层。原来三层架构通用的第三方工具包、驱动、Common、Utility、Config 等通用的公共的资源类统一放到了基础层。

## 8. 参考书籍

+ 《领域驱动设计：软件核心复杂性应对之道》  
+ 《实现领域驱动设计》    

## 9. 总结

领域的核心思想就是将问题域逐级细分，来降低业务理解和系统实现的复杂度。通过领域细分，逐步缩小微服务需要解决的问题域，构建合适的领域模型，而领域模型映射成系统就是微服务。
